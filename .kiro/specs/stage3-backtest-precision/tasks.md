# 实施计划：阶段3 - 回测精度增强

## 概述

本实施计划将阶段3的回测精度增强分解为可执行的编码任务。重点是多时间框架支持、滑点模拟和改进的订单成交逻辑。

## 任务列表

### 第1步：多时间框架支持

- [x] 1.1 创建时间框架枚举和配置
  - 创建 `Timeframe` 枚举类，支持 1m, 5m, 15m, 1h, 4h, 1d
  - 添加 `milliseconds` 属性返回时间框架对应的毫秒数
  - 添加 `recommend_timeframe()` 静态方法根据策略类型推荐时间框架
  - _需求：1.1, 1.2_

- [x] 1.2 扩展 BacktestConfig
  - 在 `BacktestConfig` 中添加 `timeframe: Timeframe` 字段
  - 设置默认值为 `Timeframe.D1` 保持向后兼容
  - 添加配置验证逻辑
  - _需求：1.2, 5.4_

- [x] 1.3 修改 MarketDataAdapter
  - 修改 `get_klines()` 方法接受 `timeframe` 参数
  - 实现根据时间框架获取或聚合数据的逻辑
  - 添加数据验证（检查时间间隔是否正确）
  - _需求：1.1, 1.4_

- [x] 1.4 更新 BacktestEngine
  - 修改 `run()` 方法使用配置的时间框架
  - 传递时间框架参数到 `MarketDataAdapter`
  - 在结果中记录使用的时间框架
  - _需求：1.4, 1.5_

- [x] 1.5 编写多时间框架测试
  - 测试每种时间框架的数据获取
  - 测试不同时间框架的回测结果一致性
  - 测试时间框架推荐逻辑
  - 性能测试：验证1年1分钟数据在30秒内完成
  - _需求：1.5, 6.1, 7.1, 7.3_

### 第2步：滑点模拟器

- [x] 2.1 创建滑点配置
  - 创建 `SlippageConfig` 数据类
  - 定义配置字段：base_slippage, size_impact_factor, volatility_impact_factor, max_slippage, model
  - 添加配置验证逻辑
  - _需求：2.4_

- [x] 2.2 实现 SlippageSimulator 核心逻辑
  - 实现 `calculate_slippage()` 方法
  - 支持多种滑点模型：linear, sqrt, volatility
  - 实现订单大小影响计算
  - 实现波动率影响计算
  - 限制最大滑点
  - _需求：2.1, 2.2, 2.3_

- [x] 2.3 实现滑点应用逻辑
  - 实现 `apply_slippage()` 方法
  - 买单滑点向上，卖单滑点向下
  - 记录滑点成本
  - 实现 `get_total_slippage_cost()` 方法
  - _需求：2.1_

- [x] 2.4 集成滑点模拟器到 BacktestEngine
  - 在 `BacktestEngine.__init__()` 中初始化 `SlippageSimulator`
  - 在订单成交时调用滑点计算
  - 使用滑点后的价格执行订单
  - 在结果中记录滑点影响
  - _需求：2.5_

- [x] 2.5 编写滑点模拟器测试
  - 单元测试：测试滑点计算公式
  - 单元测试：测试滑点应用逻辑
  - 属性测试：滑点应该随订单大小增加
  - 属性测试：滑点应该随波动率增加
  - 属性测试：滑点不应超过最大值
  - 集成测试：对比有无滑点的回测结果
  - _需求：2.5, 7.1, 7.2, 7.3_

### 第3步：订单成交优化

- [x] 3.1 创建订单成交配置
  - 创建 `OrderFillConfig` 数据类
  - 定义配置字段：enable_partial_fill, enable_realistic_timing, min_fill_ratio
  - 添加配置验证逻辑
  - _需求：3.4_

- [x] 3.2 实现 OrderFillSimulator 核心逻辑
  - 实现 `check_limit_order_fill()` 方法
  - 改进K线匹配逻辑（考虑 high/low/open/close）
  - 买单：当 low <= order_price 时成交
  - 卖单：当 high >= order_price 时成交
  - _需求：3.1_

- [x] 3.3 实现成交时间估算
  - 实现 `_estimate_fill_time()` 方法
  - 基于价格在K线内的相对位置估算成交时间
  - 支持禁用真实时间模拟（向后兼容）
  - _需求：3.5_

- [x] 3.4 实现部分成交模拟
  - 实现 `simulate_partial_fill()` 方法
  - 根据可用流动性计算实际成交数量
  - 确保至少成交最小比例
  - 支持禁用部分成交（向后兼容）
  - _需求：3.2_

- [x] 3.5 集成订单成交模拟器到 BacktestEngine
  - 在 `BacktestEngine.__init__()` 中初始化 `OrderFillSimulator`
  - 修改订单检查逻辑使用新的成交模拟器
  - 处理部分成交情况
  - 在结果中记录部分成交次数
  - _需求：3.1, 3.2, 3.5_

- [x] 3.6 编写订单成交模拟器测试
  - 单元测试：测试限价单成交条件
  - 单元测试：测试成交时间估算
  - 单元测试：测试部分成交逻辑
  - 集成测试：验证改进后的成交逻辑更准确
  - _需求：7.1, 7.3_

### 第4步：订单簿模拟器（可选）

- [ ] 4.1 创建订单簿配置
  - 创建 `OrderBookConfig` 数据类
  - 定义配置字段：enabled, depth_levels, liquidity_per_level, spread_bps
  - 默认禁用以保持向后兼容
  - _需求：4.4_

- [ ] 4.2 实现 OrderBookSimulator 核心逻辑
  - 实现 `initialize_order_book()` 方法
  - 创建简化的买卖盘深度
  - 实现 `estimate_market_impact()` 方法
  - 实现 `consume_liquidity()` 方法
  - _需求：4.1, 4.2, 4.3_

- [ ] 4.3 集成订单簿模拟器到 BacktestEngine
  - 在 `BacktestEngine.__init__()` 中初始化 `OrderBookSimulator`
  - 在回测开始时初始化订单簿
  - 在订单成交时考虑市场冲击
  - 在订单成交后消耗流动性
  - _需求：4.1, 4.2, 4.3_

- [ ] 4.4 编写订单簿模拟器测试
  - 单元测试：测试订单簿初始化
  - 单元测试：测试市场冲击计算
  - 单元测试：测试流动性消耗
  - 集成测试：验证大订单的市场冲击
  - _需求：7.1_

### 第5步：性能优化

- [x] 5.1 实现数据预处理
  - 创建 `KlinePreprocessor` 类
  - 实现 `precompute_volatility()` 方法
  - 预计算常用指标避免重复计算
  - _需求：6.1, 6.3_

- [x] 5.2 实现缓存机制
  - 为滑点计算添加 LRU 缓存
  - 缓存重复的计算结果
  - 设置合理的缓存大小
  - _需求：6.1, 6.3_

- [x] 5.3 实现向量化计算
  - 创建 `VectorizedOrderFillChecker` 类
  - 使用 NumPy 批量处理订单检查
  - 优化大量订单的处理速度
  - _需求：6.1_

- [x] 5.4 内存优化
  - 实现流式数据处理
  - 及时清理不需要的数据
  - 优化数据结构减少内存占用
  - _需求：6.3_

- [x] 5.5 性能基准测试
  - 测试不同时间框架的处理速度
  - 测试不同数据量的内存使用
  - 对比优化前后的性能
  - 验证性能目标达成
  - _需求：6.1, 6.3, 6.4_

### 第6步：扩展 BacktestResult

- [x] 6.1 扩展结果数据模型
  - 在 `BacktestResult` 中添加滑点相关字段
  - 添加 `total_slippage_cost` 字段
  - 添加 `slippage_impact_pct` 字段
  - 添加 `avg_slippage_bps` 字段
  - 添加 `partial_fills_count` 字段
  - 添加 `timeframe_used` 字段
  - _需求：2.5_

- [x] 6.2 实现滑点影响分析
  - 计算滑点占总成本的百分比
  - 计算平均滑点（基点）
  - 在结果报告中展示滑点影响
  - _需求：2.5_

- [x] 6.3 更新结果计算逻辑
  - 修改 `_calculate_result()` 方法
  - 包含滑点成本
  - 包含部分成交统计
  - 包含时间框架信息
  - _需求：2.5, 6.2_

### 第7步：配置验证和错误处理

- [x] 7.1 实现配置验证器
  - 创建 `ConfigValidator` 类
  - 实现 `validate_backtest_config()` 方法
  - 验证时间框架有效性
  - 验证滑点配置参数
  - 验证订单成交配置参数
  - 在配置无效时抛出清晰的错误
  - _需求：5.1_

- [x] 7.2 实现数据验证器
  - 创建 `DataValidator` 类
  - 实现 `validate_kline()` 方法
  - 检查价格关系（high >= low, high >= open/close等）
  - 检查成交量非负
  - 记录警告日志但不中断回测
  - _需求：5.1_

- [x] 7.3 添加错误处理逻辑
  - 处理数据异常情况
  - 处理配置错误
  - 提供清晰的错误消息
  - 记录详细的日志
  - _需求：5.1_

### 第8步：向后兼容性测试

- [x] 8.1 编写向后兼容性测试
  - 测试默认配置产生与阶段2相同的结果
  - 测试禁用新功能时的行为
  - 测试现有接口不受影响
  - _需求：5.1, 5.2, 5.3_

- [x] 8.2 编写回归测试
  - 运行所有阶段1和阶段2的测试
  - 确保所有现有测试仍然通过
  - 验证现有功能未被破坏
  - _需求：5.1, 7.4_

- [x] 8.3 测试渐进式采用
  - 测试只启用时间框架变更
  - 测试只启用滑点模拟
  - 测试启用所有新功能
  - 验证每种配置都能正常工作
  - _需求：5.1_

### 第9步：集成测试

- [x] 9.1 编写完整回测集成测试
  - 测试带滑点的完整回测流程
  - 测试不同时间框架的回测
  - 测试部分成交场景
  - 测试订单簿模拟（如果启用）
  - _需求：7.3, 7.4_

- [x] 9.2 编写精度验证测试
  - 对比有无滑点的回测结果
  - 验证滑点影响在合理范围内
  - 验证回测精度提升到±1%
  - _需求：6.2_

- [x] 9.3 编写性能集成测试
  - 测试大数据量处理
  - 测试内存使用
  - 测试处理速度
  - 验证性能目标达成
  - _需求：6.1, 6.3, 6.4_

### 第10步：文档和演示

- [x] 10.1 创建演示脚本
  - 创建 `demo_backtest_precision.py`
  - 演示多时间框架回测
  - 演示滑点影响对比
  - 演示订单成交优化效果
  - 包含详细的注释和说明
  - _需求：所有_

- [x] 10.2 更新 API 文档
  - 更新 `docs/BACKTEST_ENGINE.md`
  - 文档化新的配置选项
  - 文档化新的组件和接口
  - 提供使用示例
  - _需求：所有_

- [x] 10.3 创建用户指南
  - 创建 `docs/STAGE3_USER_GUIDE.md`
  - 说明如何选择时间框架
  - 说明如何配置滑点模拟
  - 说明如何解读新的结果指标
  - 提供最佳实践建议
  - _需求：所有_

- [x] 10.4 创建阶段完成报告
  - 创建 `STAGE3_COMPLETE.md`
  - 总结实现的功能
  - 展示性能改进数据
  - 展示精度提升数据
  - 提供使用示例和建议
  - _需求：所有_

### 第11步：最终验证

- [x] 11.1 运行完整测试套件
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试
  - 运行性能测试
  - 确保测试覆盖率>90%
  - _需求：7.1, 7.2, 7.3, 7.4_

- [x] 11.2 代码审查
  - 检查代码质量
  - 检查文档完整性
  - 检查测试覆盖
  - 检查性能优化
  - _需求：所有_

- [x] 11.3 性能验证
  - 验证1年1分钟数据在30秒内完成
  - 验证内存使用在2GB以内
  - 验证回测精度提升到±1%
  - 记录性能基准数据
  - _需求：6.1, 6.2, 6.3, 6.4_

- [x] 11.4 更新进度报告
  - 更新 `OPTIMIZATION_PROGRESS.md`
  - 标记阶段3为完成
  - 更新总体进度
  - 记录关键成果
  - _需求：所有_

## 检查点

### 检查点 1：多时间框架支持完成
- 完成任务 1.1 - 1.5
- 所有时间框架测试通过
- 性能测试达标
- 如有问题，询问用户

### 检查点 2：滑点模拟器完成
- 完成任务 2.1 - 2.5
- 所有滑点测试通过
- 滑点影响分析正确
- 如有问题，询问用户

### 检查点 3：订单成交优化完成
- 完成任务 3.1 - 3.6
- 所有成交逻辑测试通过
- 部分成交模拟正确
- 如有问题，询问用户

### 检查点 4：集成和优化完成
- 完成任务 4.1 - 7.3
- 所有集成测试通过
- 性能优化达标
- 向后兼容性验证通过
- 如有问题，询问用户

### 检查点 5：文档和最终验证完成
- 完成任务 8.1 - 11.4
- 所有文档完整
- 所有测试通过
- 性能目标达成
- 准备发布

## 预计时间

| 步骤 | 任务数 | 预计时间 |
|------|--------|----------|
| 第1步：多时间框架 | 5 | 2-3天 |
| 第2步：滑点模拟器 | 5 | 2-3天 |
| 第3步：订单成交优化 | 6 | 2-3天 |
| 第4步：订单簿模拟器 | 4 | 2-3天（可选） |
| 第5步：性能优化 | 5 | 1-2天 |
| 第6步：扩展结果 | 3 | 1天 |
| 第7步：验证和错误处理 | 3 | 1天 |
| 第8步：向后兼容性 | 3 | 1天 |
| 第9步：集成测试 | 3 | 1-2天 |
| 第10步：文档和演示 | 4 | 1-2天 |
| 第11步：最终验证 | 4 | 1天 |
| **总计** | **45** | **15-22天** |

## 注意事项

- 所有任务都引用了具体的需求编号
- 检查点确保增量验证
- 向后兼容性是关键要求
- 性能目标必须达成
- 测试覆盖率必须>90%
- 文档必须完整清晰

---

**文档版本：** 1.0  
**创建日期：** 2026-02-01  
**最后更新：** 2026-02-01  
**状态：** 待执行
