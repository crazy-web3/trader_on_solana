# 实施计划：回测引擎优化

## 概述

本实施计划将合约网格交易回测系统的优化分解为可执行的编码任务。重点是算法准确性、代码可维护性和测试覆盖。

## 任务列表

- [x] 1. 创建核心组件类和接口
  - 创建 `strategy_engine/components/` 目录
  - 实现 `OrderManager` 类，负责订单管理
  - 实现 `PositionManager` 类，负责仓位管理
  - 实现 `MarginCalculator` 类，负责保证金计算
  - 实现 `PnLCalculator` 类，负责盈亏计算
  - 实现 `FundingFeeCalculator` 类，负责资金费率计算
  - 更新 `Position` 数据模型，添加必要字段
  - _需求：7.1, 7.2, 7.3, 7.4_

- [x] 1.1 为核心组件编写单元测试
  - 测试 `OrderManager` 的订单放置和检查逻辑
  - 测试 `PositionManager` 的开平仓逻辑
  - 测试 `MarginCalculator` 的保证金计算
  - 测试 `PnLCalculator` 的盈亏计算
  - 测试 `FundingFeeCalculator` 的费率计算
  - _需求：8.2_

- [x] 2. 实现 OrderManager 订单管理逻辑
  - [x] 2.1 实现 `place_initial_orders` 方法
    - 根据策略模式（做多/做空/中性）放置初始订单
    - 确保订单价格在网格区间内
    - 计算每个网格的订单数量
    - _需求：1.1_
  
  - [x] 2.2 实现 `check_order_fills` 方法
    - 检查买单：K线最低价 <= 订单价格
    - 检查卖单：K线最高价 >= 订单价格
    - 返回所有应该成交的订单列表
    - _需求：1.2_
  
  - [x] 2.3 实现 `place_counter_order` 方法
    - 做多网格：买单成交后在上一网格挂卖单
    - 做空网格：卖单成交后在下一网格挂买单
    - 中性网格：订单成交后在对手网格挂平仓订单
    - _需求：1.3, 1.4, 1.5, 1.6_

- [x] 2.4 为 OrderManager 编写属性测试
  - **属性 1：订单初始化正确性**
  - **验证：需求 1.1**
  - **属性 2：订单触发准确性**
  - **验证：需求 1.2**
  - **属性 3：对手订单放置正确性**
  - **验证：需求 1.3, 1.4, 1.5, 1.6**

- [x] 3. 实现 PositionManager 仓位管理逻辑
  - [x] 3.1 实现 `open_position` 方法
    - 在指定网格创建新仓位
    - 记录开仓价格、数量和时间
    - 更新净仓位
    - _需求：4.5_
  
  - [x] 3.2 实现 `close_position` 方法
    - 减少或清除指定网格的仓位
    - 返回被平掉的仓位信息
    - 更新净仓位
    - _需求：4.6_
  
  - [x] 3.3 实现 `find_matching_position` 方法
    - 做多网格卖单：查找下一网格的多仓
    - 做空网格买单：查找上一网格的空仓
    - 中性网格：查找对手网格的反向仓位
    - 无配对时返回 None
    - _需求：4.1, 4.2, 4.3, 4.4_
  
  - [x] 3.4 实现 `get_net_position` 方法
    - 计算所有网格仓位的总和
    - 正数表示净多仓，负数表示净空仓
    - _需求：4.5_

- [x] 3.5 为 PositionManager 编写属性测试
  - **属性 12：订单配对正确性**
  - **验证：需求 4.1, 4.2, 4.3**
  - **属性 13：无配对仓位处理**
  - **验证：需求 4.4**
  - **属性 14：仓位独立性**
  - **验证：需求 4.5**
  - **属性 15：仓位清理正确性**
  - **验证：需求 4.6**

- [x] 4. 实现 MarginCalculator 保证金计算逻辑
  - [x] 4.1 实现 `calculate_required_margin` 方法
    - 计算公式：quantity × price / leverage
    - 返回所需保证金金额
    - _需求：2.1_
  
  - [x] 4.2 实现 `allocate_margin` 方法
    - 检查可用资金是否充足
    - 如果充足，增加已用保证金并返回 True
    - 如果不足，返回 False 且不修改状态
    - _需求：2.2_
  
  - [x] 4.3 实现 `release_margin` 方法
    - 减少已用保证金
    - 确保已用保证金不会变为负数
    - _需求：2.3_
  
  - [x] 4.4 实现 `get_available_capital` 方法
    - 计算公式：total_capital - used_margin
    - 返回可用资金
    - _需求：2.4_

- [x] 4.5 为 MarginCalculator 编写属性测试
  - **属性 4：保证金计算正确性**
  - **验证：需求 2.1, 2.4**
  - **属性 5：保证金不变式**
  - **验证：需求 2.5**
  - **属性 6：保证金不足拒绝**
  - **验证：需求 2.2**
  - **属性 7：保证金释放正确性**
  - **验证：需求 2.3**

- [x] 5. 实现 PnLCalculator 盈亏计算逻辑
  - [x] 5.1 实现 `calculate_realized_pnl` 方法
    - 做多：(close_price - open_price) × quantity
    - 做空：(open_price - close_price) × quantity
    - 返回已实现盈亏
    - _需求：3.1_
  
  - [x] 5.2 实现 `calculate_unrealized_pnl` 方法
    - 遍历所有未平仓头寸
    - 计算每个头寸的 (current_price - entry_price) × quantity
    - 返回未实现盈亏总和
    - _需求：3.2_
  
  - [x] 5.3 实现 `calculate_equity` 方法
    - 计算公式：capital + unrealized_pnl
    - 返回当前权益
    - _需求：3.3_
  
  - [x] 5.4 实现 `add_realized_pnl` 方法
    - 累加已实现盈亏到 grid_profit
    - 更新当前资金
    - _需求：3.4, 3.5_

- [x] 5.5 为 PnLCalculator 编写属性测试
  - **属性 8：已实现盈亏计算正确性**
  - **验证：需求 3.1**
  - **属性 9：未实现盈亏计算正确性**
  - **验证：需求 3.2, 3.3**
  - **属性 10：资金守恒定律**
  - **验证：需求 3.6**
  - **属性 11：盈亏更新正确性**
  - **验证：需求 3.4, 3.5**

- [x] 6. 实现 FundingFeeCalculator 资金费率计算逻辑
  - [x] 6.1 实现 `should_settle_funding` 方法
    - 检查当前时间与上次结算时间的差值
    - 如果超过资金费率间隔，返回 True
    - _需求：5.4_
  
  - [x] 6.2 实现 `calculate_funding_fee` 方法
    - 计算公式：position_size × current_price × funding_rate
    - 多仓返回正数（支付），空仓返回负数（收取）
    - _需求：5.1, 5.2, 5.3_
  
  - [x] 6.3 实现 `settle_funding` 方法
    - 更新上次结算时间
    - 累加资金费用到总费用
    - _需求：5.5_
  
  - [x] 6.4 添加零仓位检查
    - 如果净仓位为零，不计算资金费用
    - _需求：5.6_

- [x] 6.5 为 FundingFeeCalculator 编写属性测试
  - **属性 16：资金费率计算正确性**
  - **验证：需求 5.1, 5.2, 5.3**
  - **属性 17：资金费率结算时间正确性**
  - **验证：需求 5.4**
  - **属性 18：资金费用累加正确性**
  - **验证：需求 5.5**
  - **属性 19：零仓位无费用**
  - **验证：需求 5.6**

- [x] 7. 检查点 - 确保所有组件测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 修复发现的问题
  - 如有疑问，询问用户

- [x] 8. 重构 GridStrategyEngine 使用新组件
  - [x] 8.1 更新 `__init__` 方法
    - 初始化所有组件（OrderManager、PositionManager等）
    - 使用依赖注入模式
    - 移除旧的初始化逻辑
    - _需求：7.6_
  
  - [x] 8.2 重构 `_process_kline` 方法
    - 使用 OrderManager 检查订单成交
    - 使用 PositionManager 管理仓位
    - 使用 MarginCalculator 管理保证金
    - 使用 PnLCalculator 计算盈亏
    - 使用 FundingFeeCalculator 处理资金费率
    - _需求：1.2, 2.6, 5.1, 6.6_
  
  - [x] 8.3 重构 `_fill_order` 方法
    - 先扣除手续费
    - 检查保证金是否充足
    - 查找配对仓位
    - 如果有配对，计算已实现盈亏并平仓
    - 如果无配对，开新仓
    - 更新资金和保证金
    - _需求：2.6, 3.5, 4.1, 4.2, 4.3, 4.4_
  
  - [x] 8.4 重构 `_calculate_current_equity` 方法
    - 使用 PnLCalculator 计算未实现盈亏
    - 使用 PnLCalculator 计算权益
    - _需求：3.2, 3.3_
  
  - [x] 8.5 删除旧的初始化方法
    - 删除 `_initialize_grid` 方法
    - 删除 `_place_initial_positions_from_start` 方法
    - 保留 `_place_initial_orders`，但委托给 OrderManager
    - _需求：7.1_

- [x] 8.6 为重构后的 GridStrategyEngine 编写集成测试
  - 测试完整的回测流程
  - 测试三种策略模式（做多/做空/中性）
  - 测试边界情况（保证金不足、价格超出区间等）
  - _需求：8.2_

- [x] 9. 优化 BacktestEngine 性能指标计算
  - [x] 9.1 修复 `_calculate_metrics` 方法
    - 确保总收益率计算正确
    - 确保年化收益率计算正确
    - 确保最大回撤计算正确
    - _需求：6.1, 6.2, 6.3_
  
  - [x] 9.2 修复 `_calculate_sharpe_ratio` 方法
    - 使用日收益率计算
    - 计算均值和标准差
    - 年化处理（乘以 sqrt(365)）
    - _需求：6.4_
  
  - [x] 9.3 添加胜率计算
    - 统计盈利交易数和总交易数
    - 计算胜率 = 盈利交易数 / 总交易数
    - _需求：6.5_

- [x] 9.4 为性能指标计算编写属性测试
  - **属性 20：性能指标计算正确性**
  - **验证：需求 6.1, 6.2, 6.3, 6.4, 6.5**
  - **属性 21：权益曲线更新正确性**
  - **验证：需求 6.6**

- [x] 10. 检查点 - 运行完整回归测试
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试
  - 对比新旧版本的回测结果
  - 修复发现的问题
  - 如有疑问，询问用户

- [x] 11. 性能优化
  - [x] 11.1 优化数据结构
    - 确认使用字典存储仓位和订单
    - 预计算网格价格
    - 移除不必要的列表操作
  
  - [x] 11.2 优化算法
    - 批量处理订单检查
    - 延迟计算未实现盈亏
    - 缓存权益曲线计算
  
  - [x] 11.3 内存优化
    - 及时清理已平仓位
    - 限制交易记录数量（可选）

- [x] 11.4 运行性能基准测试
  - 对比优化前后的执行时间
  - 对比优化前后的内存使用
  - 记录性能提升数据

- [x] 12. 更新文档和示例
  - 更新 `docs/STRATEGY_ENGINE.md` 文档
  - 更新 `docs/BACKTEST_ENGINE.md` 文档
  - 添加新组件的使用示例
  - 更新 API 文档

- [x] 13. 最终检查点 - 确保所有测试通过
  - 运行完整测试套件
  - 检查测试覆盖率
  - 修复所有失败的测试
  - 确认所有属性测试至少运行100次迭代
  - 如有疑问，询问用户

## 注意事项

- 所有任务都是必需的，包括测试任务
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
