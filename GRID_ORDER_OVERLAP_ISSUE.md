# 网格订单覆盖问题

## 问题描述

当前的网格交易实现存在订单覆盖问题，导致某些交易机会被错过，特别是在做空和做多策略中。

## 根本原因

当前的订单管理使用字典结构`Dict[int, GridOrder]`，每个网格只能有一个订单。当对手订单需要放置在已有订单的网格上时，会出现以下情况：

### 示例场景（做空网格）

价格从 $50000 上涨到 $52000：

1. **网格5卖单成交**（$50556）
   - 开空仓在网格5
   - 对手订单：在网格4挂买单

2. **网格6卖单成交**（$51667）
   - 开空仓在网格6
   - 对手订单：在网格5挂买单 ← **覆盖了网格4的买单！**

3. 价格下跌到 $47000：
   - 网格5买单成交 → 平网格6的空仓 ✓
   - 网格4买单成交 → 平网格5的空仓 ✓
   - **但网格5的空仓本应由网格4的买单平仓，现在被网格5的买单（来自网格6）平了！**

### 问题影响

1. **交易次数减少**：某些对手订单被覆盖，导致交易机会减少
2. **收益不准确**：配对逻辑错误导致盈亏计算不符合预期
3. **策略行为异常**：做空/做多策略的表现不如预期

## 当前的权宜之计

修改对手订单放置逻辑，只在目标网格没有订单或订单已成交时才放置：

```python
if next_grid_idx not in self.pending_orders or self.pending_orders[next_grid_idx].is_filled:
    counter_order = GridOrder(next_grid_idx, next_price, side, quantity)
    self.pending_orders[next_grid_idx] = counter_order
```

### 权宜之计的问题

这个方法避免了覆盖，但会导致某些对手订单无法放置，进一步减少交易机会。

## 根本解决方案

需要重构订单管理系统，支持同一网格有多个订单：

### 方案1：使用订单队列

```python
pending_orders: Dict[int, List[GridOrder]]  # 每个网格可以有多个订单
```

**优点**：
- 支持同一网格多个订单
- 不会丢失交易机会

**缺点**：
- 需要重构大量代码
- 订单匹配逻辑变复杂
- 需要决定订单执行顺序（FIFO? LIFO?）

### 方案2：为每个订单分配唯一ID

```python
@dataclass
class GridOrder:
    order_id: str  # 唯一ID
    grid_idx: int
    price: float
    side: str
    quantity: float
    is_filled: bool = False

pending_orders: Dict[str, GridOrder]  # 按订单ID索引
grid_orders: Dict[int, List[str]]  # 每个网格的订单ID列表
```

**优点**：
- 更灵活的订单管理
- 可以追踪每个订单的生命周期

**缺点**：
- 实现复杂度高
- 需要重构整个订单管理系统

### 方案3：使用不同的对手订单策略

不使用相邻网格，而使用更远的网格来避免覆盖：

```python
# 做多网格：买单成交后在grid+2挂卖单（而不是grid+1）
# 做空网格：卖单成交后在grid-2挂买单（而不是grid-1）
```

**优点**：
- 实现简单
- 避免大部分覆盖问题

**缺点**：
- 改变了网格交易的基本逻辑
- 可能不符合用户预期
- 价差变大，交易频率降低

## 当前状态

- ✓ 未实现盈亏计算已修复
- ✓ 中性网格策略已修复（使用对称网格）
- ⚠️ 做多/做空网格存在订单覆盖问题
- ⏳ 需要决定采用哪种解决方案

## 建议

短期内，保持当前的权宜之计（跳过已有订单），并在文档中说明这个限制。

长期来看，建议采用**方案1（订单队列）**，因为：
1. 最符合网格交易的本质
2. 不改变交易逻辑
3. 实现复杂度适中

## 测试数据

使用价格序列 $50000 → $48000 → $52000 → $47000 → $53000 → $50000：

| 策略 | 交易次数 | 网格收益 | 未实现盈亏 | 总盈亏 |
|------|---------|----------|------------|--------|
| 做多网格 | 16 | $68.21 | $53.08 | $117.26 |
| 做空网格 | 9 | $43.02 | $5.49 | $46.29 |
| 中性网格 | 10 | $22.47 | $127.79 | $147.69 |

做空网格的交易次数明显少于做多网格，这是订单覆盖问题的直接体现。

## 参考

- `strategy_engine/components/order_manager.py` - 订单管理实现
- `strategy_engine/components/position_manager.py` - 仓位管理实现
- `NEUTRAL_GRID_FIX_SUMMARY.md` - 中性网格修复文档
- `UNREALIZED_PNL_FIX_SUMMARY.md` - 未实现盈亏修复文档
