# 合约网格交易回测算法优化方案

## 文档分析总结

根据《合约网格交易说明文档》，关键要点：

### 1. 网格交易机制核心
- **等差网格**：价差相等，每个网格的价差 = (上限 - 下限) / 网格数量
- **等比网格**：价格比率相等，价格比率 = (上限 / 下限) ^ (1 / 网格数量)
- **网格更新**：每次触及价格点时，该价格点"关闭"，不再触发订单

### 2. 三种网格模式
- **做多网格**：初始建多仓，低价位买入，高价位卖出
- **做空网格**：初始建空仓，高价位卖出，低价位买入
- **中性网格**：不开立初始仓位，先买后卖或先卖后买

### 3. 初始仓位建立
- **有初始仓位**：T+0时立即建仓，T+1时替换为对冲订单
- **无初始仓位**：只在市场价超越最接近的价格点位时建立初始仓位

### 4. 关键计算公式
- **每格收益**（等差）：最低收益 = (上限 * (1-c)) / (上限 - d) - 1 - c
- **每格收益**（等比）：收益 = (1-c) * r - 1 - c
- **占用保证金**：当前名义价值 / 杠杆倍数
- **机器人风险率**：保证金余额 / 占用保证金

## 当前代码问题分析

### 1. 网格初始化问题
- ❌ 没有区分等差和等比网格
- ❌ 初始仓位建立逻辑不符合文档规范
- ❌ 没有正确处理"最接近价格点位排除"规则

### 2. 订单执行问题
- ❌ 没有实现"网格关闭"机制（已成交的价格点不应再触发）
- ❌ 订单填充逻辑过于简化，没有考虑K线的高低价
- ❌ 没有正确处理多个订单同时成交的情况

### 3. 保证金管理问题
- ❌ 没有实现动态保证金追加机制
- ❌ 没有计算机器人风险率
- ❌ 没有考虑杠杆区间调整

### 4. 收益计算问题
- ❌ 没有区分"已撮合收益"和"未撮合盈亏"
- ❌ 没有正确计算每格收益
- ❌ 没有考虑资金费用的准确计算

### 5. 数据精度问题
- ❌ 没有考虑最小变动价位限制
- ❌ 没有验证价差是否满足最小差价要求

## 优化方案

### Phase 1: 核心算法优化
1. 实现等差和等比网格模式
2. 修复网格初始化逻辑
3. 实现网格关闭机制
4. 优化订单执行逻辑

### Phase 2: 保证金和风险管理
1. 实现动态保证金计算
2. 添加机器人风险率计算
3. 实现杠杆区间调整
4. 添加强平价格计算

### Phase 3: 收益计算优化
1. 区分已撮合和未撮合收益
2. 实现准确的每格收益计算
3. 优化资金费用计算
4. 添加数据精度验证

### Phase 4: 性能和可靠性
1. 添加详细的日志和调试信息
2. 优化性能（减少计算量）
3. 添加更多的单元测试
4. 完善错误处理

## 实现优先级

**高优先级**（必须实现）：
- 等差/等比网格模式
- 网格关闭机制
- 正确的初始仓位建立
- 准确的订单执行

**中优先级**（应该实现）：
- 动态保证金管理
- 机器人风险率
- 每格收益计算
- 数据精度验证

**低优先级**（可选）：
- 杠杆区间调整
- 强平价格计算
- 性能优化
