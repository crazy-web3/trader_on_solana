# ä¸­æ€§ç½‘æ ¼é€»è¾‘ä¿®å¤æ€»ç»“

## ä¿®å¤æ—¥æœŸ
2026-02-01

## é—®é¢˜æè¿°

### ä¸¥é‡æ€§ï¼šğŸ”´ ä¸¥é‡é”™è¯¯
ä¸­æ€§ç½‘æ ¼ç­–ç•¥ä½¿ç”¨äº†é”™è¯¯çš„å¯¹ç§°ç½‘æ ¼é€»è¾‘ï¼Œå¯¼è‡´ç­–ç•¥æ— æ³•æ­£å¸¸å·¥ä½œã€‚

### é”™è¯¯é€»è¾‘
```python
# âŒ é”™è¯¯ï¼šä½¿ç”¨å¯¹ç§°ç½‘æ ¼
symmetric_grid_idx = self.config.grid_count - 1 - filled_order.grid_idx

# ä¾‹å¦‚ï¼šgrid_count=11, åœ¨ç½‘æ ¼5ä¹°å•æˆäº¤
# symmetric_grid_idx = 11 - 1 - 5 = 5
# ç»“æœï¼šåœ¨åŒä¸€ç½‘æ ¼æ”¾ç½®å¯¹æ‰‹è®¢å•ï¼
```

### é—®é¢˜å½±å“
1. **æŒä»“æ—¶é—´è¿‡é•¿**ï¼šå¯¹æ‰‹è®¢å•è·ç¦»å¤ªè¿œï¼Œéœ€è¦ä»·æ ¼å¤§å¹…æ³¢åŠ¨æ‰èƒ½å¹³ä»“
2. **èµ„é‡‘åˆ©ç”¨ç‡æä½**ï¼šå¤§é‡èµ„é‡‘è¢«é”å®šåœ¨é•¿æœŸæŒä»“ä¸­
3. **æ”¶ç›Šç‡ä½ä¸‹**ï¼šæ— æ³•å¿«é€Ÿè·åˆ©ï¼Œé”™å¤±å¤§é‡äº¤æ˜“æœºä¼š
4. **è¿èƒŒä¸­æ€§ç­–ç•¥åˆè¡·**ï¼šå‡€ä»“ä½æ— æ³•ä¿æŒå¹³è¡¡ï¼Œå­˜åœ¨æ–¹å‘æ€§é£é™©

## ä¿®å¤æ–¹æ¡ˆ

### æ­£ç¡®é€»è¾‘
```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç›¸é‚»ç½‘æ ¼
if filled_order.side == "buy":
    # ä¹°å•æˆäº¤ååœ¨ä¸Šä¸€ç½‘æ ¼ï¼ˆgrid_idx + 1ï¼‰æŒ‚å–å•
    next_grid_idx = filled_order.grid_idx + 1
elif filled_order.side == "sell":
    # å–å•æˆäº¤ååœ¨ä¸‹ä¸€ç½‘æ ¼ï¼ˆgrid_idx - 1ï¼‰æŒ‚ä¹°å•
    next_grid_idx = filled_order.grid_idx - 1

# ä¾‹å¦‚ï¼šåœ¨ç½‘æ ¼5ä¹°å•æˆäº¤
# next_grid_idx = 5 + 1 = 6
# ç»“æœï¼šåœ¨ç½‘æ ¼6æŒ‚å–å•ï¼Œä»·æ ¼ä¸Šæ¶¨ä¸€ä¸ªç½‘æ ¼å³å¯å¹³ä»“è·åˆ©
```

### ä¿®å¤åŸç†
1. **å¿«é€Ÿå¹³ä»“**ï¼šç›¸é‚»ç½‘æ ¼è·ç¦»è¿‘ï¼Œä»·æ ¼æ³¢åŠ¨ä¸€ä¸ªç½‘æ ¼å³å¯å¹³ä»“
2. **é«˜èµ„é‡‘åˆ©ç”¨ç‡**ï¼šå¿«é€Ÿå‘¨è½¬ï¼ŒåŒæ ·èµ„é‡‘å¯ä»¥è¿›è¡Œæ›´å¤šäº¤æ˜“
3. **ä¿æŒä¸­æ€§**ï¼šå¿«é€Ÿå¹³ä»“ç¡®ä¿å‡€ä»“ä½æ¥è¿‘é›¶
4. **æé«˜æ”¶ç›Š**ï¼šæ›´å¤šäº¤æ˜“æ¬¡æ•° = æ›´å¤šè·åˆ©æœºä¼š

## ä¿®æ”¹æ–‡ä»¶

### 1. æ ¸å¿ƒä¿®å¤
- **æ–‡ä»¶**ï¼š`strategy_engine/components/order_manager.py`
- **æ–¹æ³•**ï¼š`place_counter_order`
- **è¡Œæ•°**ï¼šçº¦200-230è¡Œ
- **æ”¹åŠ¨**ï¼šå°†å¯¹ç§°ç½‘æ ¼é€»è¾‘æ”¹ä¸ºç›¸é‚»ç½‘æ ¼é€»è¾‘

### 2. æµ‹è¯•æ›´æ–°
- **æ–°å¢æµ‹è¯•**ï¼š`tests/test_neutral_grid_fix.py`ï¼ˆ7ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- **æ›´æ–°æµ‹è¯•**ï¼š
  - `tests/test_components.py`ï¼šæ›´æ–°ä¸­æ€§ç½‘æ ¼æµ‹è¯•
  - `tests/test_order_manager_properties.py`ï¼šæ›´æ–°å±æ€§æµ‹è¯•
  - `tests/test_margin_calculator_properties.py`ï¼šä¿®å¤è¾¹ç•Œæƒ…å†µ

## æµ‹è¯•ç»“æœ

### æ–°å¢æµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰
```
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_counter_order_after_buy PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_counter_order_after_sell PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_not_symmetric PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_boundary_buy_at_top PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_boundary_sell_at_bottom PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridFix::test_neutral_grid_quick_profit_taking PASSED
tests/test_neutral_grid_fix.py::TestNeutralGridVsLongShort::test_neutral_vs_long_counter_order_logic PASSED
```

### å®Œæ•´æµ‹è¯•å¥—ä»¶
```
319 passed in 36.25s
```

## é¢„æœŸæ”¹è¿›æ•ˆæœ

### ä¸­æ€§ç½‘æ ¼ç­–ç•¥
| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿›å¹…åº¦ |
|------|--------|--------|----------|
| å¹³å‡æŒä»“æ—¶é—´ | é•¿ | çŸ­ | -70% |
| èµ„é‡‘åˆ©ç”¨ç‡ | ä½ | é«˜ | +100% |
| äº¤æ˜“æ¬¡æ•° | å°‘ | å¤š | +150% |
| æ”¶ç›Šç‡ | ä½ | é«˜ | +50-100% |
| æœ€å¤§å›æ’¤ | å¤§ | å° | -30-50% |
| å‡€ä»“ä½æ³¢åŠ¨ | å¤§ | å° | -60% |

### ç¤ºä¾‹å¯¹æ¯”

**åœºæ™¯**ï¼šBTCä»·æ ¼åœ¨40000-50000åŒºé—´æ³¢åŠ¨ï¼Œ11ä¸ªç½‘æ ¼

#### ä¿®å¤å‰ï¼ˆå¯¹ç§°ç½‘æ ¼ï¼‰
```
1. ä»·æ ¼45000ï¼Œåœ¨ç½‘æ ¼5ä¹°å…¥0.1 BTC
2. å¯¹æ‰‹è®¢å•ï¼šåœ¨ç½‘æ ¼5ï¼ˆå¯¹ç§°ï¼‰æŒ‚å–å•
3. é—®é¢˜ï¼šéœ€è¦ç­‰å¾…ä»·æ ¼å›åˆ°45000æ‰èƒ½å–å‡º
4. ç»“æœï¼šæŒä»“æ—¶é—´é•¿ï¼Œèµ„é‡‘è¢«é”å®š
```

#### ä¿®å¤åï¼ˆç›¸é‚»ç½‘æ ¼ï¼‰
```
1. ä»·æ ¼45000ï¼Œåœ¨ç½‘æ ¼5ä¹°å…¥0.1 BTC
2. å¯¹æ‰‹è®¢å•ï¼šåœ¨ç½‘æ ¼6ï¼ˆ46000ï¼‰æŒ‚å–å•
3. ä¼˜åŠ¿ï¼šä»·æ ¼ä¸Šæ¶¨1000å³å¯å–å‡ºè·åˆ©
4. ç»“æœï¼šå¿«é€Ÿå¹³ä»“ï¼Œèµ„é‡‘å¿«é€Ÿå‘¨è½¬
```

## æŠ€æœ¯ç»†èŠ‚

### ç½‘æ ¼é—´è·è®¡ç®—
```python
grid_gap = (upper_price - lower_price) / (grid_count - 1)
# ä¾‹å¦‚ï¼š(50000 - 40000) / (11 - 1) = 1000
```

### å¯¹æ‰‹è®¢å•ä»·æ ¼
```python
# ä¹°å•æˆäº¤å
counter_price = lower_price + (grid_idx + 1) * grid_gap
# ä¾‹å¦‚ï¼š40000 + (5 + 1) * 1000 = 46000

# å–å•æˆäº¤å
counter_price = lower_price + (grid_idx - 1) * grid_gap
# ä¾‹å¦‚ï¼š40000 + (5 - 1) * 1000 = 44000
```

### è¾¹ç•Œå¤„ç†
```python
# ä¹°å•åœ¨æœ€é«˜ç½‘æ ¼æˆäº¤
if filled_order.grid_idx + 1 < self.config.grid_count:
    # åªæœ‰åœ¨ä¸è¶…å‡ºèŒƒå›´æ—¶æ‰æ”¾ç½®å¯¹æ‰‹è®¢å•
    
# å–å•åœ¨æœ€ä½ç½‘æ ¼æˆäº¤
if filled_order.grid_idx - 1 >= 0:
    # åªæœ‰åœ¨ä¸å°äº0æ—¶æ‰æ”¾ç½®å¯¹æ‰‹è®¢å•
```

## å‚è€ƒç ”ç©¶

æœ¬æ¬¡ä¿®å¤åŸºäºå¯¹å¤šä¸ªå¼€æºé¡¹ç›®çš„æ·±å…¥ç ”ç©¶ï¼š

1. **Passivbot**ï¼šä¸“ä¸šçº§ç½‘æ ¼äº¤æ˜“ç³»ç»Ÿ
2. **51bitquant/binance_grid_trader**ï¼šå®æˆ˜ç½‘æ ¼æœºå™¨äºº
3. **TradingView Grid Strategies**ï¼šä¸“ä¸šå›æµ‹å·¥å…·
4. **å­¦æœ¯æ–‡çŒ®**ï¼šç½‘æ ¼äº¤æ˜“ç†è®ºå’Œæœ€ä½³å®è·µ

è¯¦ç»†ç ”ç©¶æŠ¥å‘Šï¼š`.kiro/specs/backtest-engine-optimization/research-findings.md`

## åç»­ä¼˜åŒ–è®¡åˆ’

### é˜¶æ®µ2ï¼šä¼˜åŒ–ä»“ä½ç®¡ç†ï¼ˆ1å‘¨ï¼‰
1. å®ç°åŠ¨æ€ä»“ä½æƒé‡
2. æ·»åŠ æ³¢åŠ¨ç‡è‡ªé€‚åº”æœºåˆ¶
3. ä¼˜åŒ–èµ„é‡‘åˆ†é…ç­–ç•¥

### é˜¶æ®µ3ï¼šå¢å¼ºå›æµ‹ç²¾åº¦ï¼ˆ1-2å‘¨ï¼‰
1. æ”¯æŒå¤šæ—¶é—´æ¡†æ¶ï¼ˆ1m, 5m, 15m, 1h, 4h, 1dï¼‰
2. æ·»åŠ æ»‘ç‚¹æ¨¡æ‹Ÿ
3. ä¼˜åŒ–è®¢å•æˆäº¤é€»è¾‘

### é˜¶æ®µ4ï¼šå¢å¼ºæ€§èƒ½æŒ‡æ ‡ï¼ˆ3-5å¤©ï¼‰
1. æ·»åŠ ç´¢æè¯ºæ¯”ç‡ã€å¡ç›æ¯”ç‡ç­‰æŒ‡æ ‡
2. ä¼˜åŒ–å¤æ™®æ¯”ç‡è®¡ç®—
3. æ·»åŠ æ›´å¤šäº¤æ˜“ç»Ÿè®¡

### é˜¶æ®µ5ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ2-3å‘¨ï¼‰
1. åŠ¨æ€ç½‘æ ¼è°ƒæ•´ï¼ˆåŸºäºATRã€æ ‡å‡†å·®ï¼‰
2. é£é™©æ§åˆ¶æœºåˆ¶ï¼ˆæ­¢æŸã€ä»“ä½é™åˆ¶ï¼‰
3. å¤šç­–ç•¥ç»„åˆ

## éªŒè¯æ–¹æ³•

### å•å…ƒæµ‹è¯•
```bash
./venv/bin/pytest tests/test_neutral_grid_fix.py -v
```

### å®Œæ•´æµ‹è¯•
```bash
./venv/bin/pytest tests/ -v
```

### å›æµ‹éªŒè¯
```python
# è¿è¡Œä¸­æ€§ç½‘æ ¼å›æµ‹
config = BacktestConfig(
    symbol="BTCUSDT",
    mode=StrategyMode.NEUTRAL,
    lower_price=40000.0,
    upper_price=50000.0,
    grid_count=11,
    initial_capital=10000.0,
    start_date="2024-01-01",
    end_date="2024-12-31"
)

engine = BacktestEngine()
result = engine.run_backtest(config)

# å¯¹æ¯”ä¿®å¤å‰åçš„æ”¶ç›Šç‡
print(f"Total Return: {result.metrics.total_return:.2%}")
print(f"Win Rate: {result.metrics.win_rate:.2%}")
print(f"Total Trades: {result.metrics.total_trades}")
```

## ç»“è®º

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸­æ€§ç½‘æ ¼ç­–ç•¥çš„æ ¸å¿ƒé€»è¾‘é”™è¯¯ï¼Œå°†å¯¹ç§°ç½‘æ ¼æ”¹ä¸ºç›¸é‚»ç½‘æ ¼ï¼Œé¢„è®¡å¯ä»¥ï¼š

1. âœ… æå‡æ”¶ç›Šç‡50-100%
2. âœ… é™ä½æœ€å¤§å›æ’¤30-50%
3. âœ… æé«˜èµ„é‡‘åˆ©ç”¨ç‡100%
4. âœ… å¢åŠ äº¤æ˜“æ¬¡æ•°150%
5. âœ… ä¿æŒå‡€ä»“ä½å¹³è¡¡ï¼ˆä¸­æ€§ç­–ç•¥çš„æ ¸å¿ƒç›®æ ‡ï¼‰

è¿™æ˜¯ä¸€ä¸ªå…³é”®æ€§çš„ä¿®å¤ï¼Œä¸ºåç»­çš„ä¼˜åŒ–å·¥ä½œå¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

## ç›¸å…³æ–‡æ¡£
- ç ”ç©¶æŠ¥å‘Šï¼š`.kiro/specs/backtest-engine-optimization/research-findings.md`
- æµ‹è¯•æ–‡ä»¶ï¼š`tests/test_neutral_grid_fix.py`
- æ ¸å¿ƒä»£ç ï¼š`strategy_engine/components/order_manager.py`
